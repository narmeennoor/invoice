<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
    crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <style>
    .ui-autocomplete {
      z-index: 2050;
    }
  </style>
  <script src="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/alertify.min.js"></script>
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/alertify.min.css" />
  <link rel="stylesheet" href="unitstyle.css">
  <!-- Default theme -->
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/default.min.css" />
  <script src="https://kit.fontawesome.com/e30902090a.js" crossorigin="anonymous"></script>

  <title>Product Master</title>
</head>

<body>

  <!-- navbar -->
  <div id="navbar"> </div>

  <!-- buttons -->
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">Add</button>
  <button onClick="window.location.href=window.location.href" class="btn btn-secondary">Refresh Page</button>
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#filtermodal">Filter</button>
  <input id="search" type="text" placeholder="&#xF002; Search for name" style="font-family: Arial, FontAwesome"></input>
  <hr>

  <!-- table -->
  <table class="table table-bordered " id="table">
    <thead>

      <tr>
        <th scope="col" hidden="">Keycode</th>
        <th scope="col">Product Code</th>
        <th scope="col">Product Name</th>
        <th scope="col">Units</th>
        <th scope="col">Rate</th>
        <th scope="col">Stock</th>
        <th scope="col">Edit</th>
        <th scope="col">Delete</th>
      </tr>
    </thead>
    <tbody class="productmaster">

    </tbody>
  </table>

  <!-- ADD Modal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content addmodal">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">ADDING DETAILS INTO THE TABLE</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="login-box-msg"></div>
          <form id="addform" class="form" name="myForm" autocomplete="off">
            Enter the details below</br><br>
            <label style="width:12rem;">Product Code:</label>
            <input type="text" placeholder="Product Code" id="pdcode"><span id="status" required></span></input>
            <span id="pdcodecheck" style="color: red;">
              **field is required
            </span><br><br>


            <label style="width:12rem;">Product Name:</label>
            <input type="text" placeholder="Product Name" id="pdname" required></input>
            <span id="pdnamecheck" style="color: red;">
              **field is required
            </span><br><br>

            <label style="width:12rem;">Units:</label>
            <select name="units" id="units">
              <option value="">select option</option>
            </select>
            <span id="unitcheck" style="color: red;">
              **field is required
            </span><br><br>


            <label style="width:12rem;">Rate:</label>
            <input type="number" placeholder="Rate" id="rate" required></input>
            <span id="ratecheck" style="color: red;">
              **field is required
            </span><br><br>


            <label style="width:12rem;">Stock:</label>
            <input type="number" placeholder="Stock" id="stock" required></input>
            <span id="stockcheck" style="color: red;">
              **field is required
            </span><br><br>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary" id="btnsave">
            save
          </button>
        </div>
      </div>
    </div>
  </div>


  <!-- Edit modal -->

  <div class="modal fade" id="EditModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Edit Data </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <input type="text" id="keycode" class="form-control" hidden="">
            <div class="col-md-5">
              <label for="">Product Code</label>
              <input type="text" id="edit_code" class="form-control">
            </div><br><br>
            <div class="col-md-5">
              <label for="">Product Name</label>
              <input type="text" id="edit_name" class="form-control">
            </div><br><br><br><br>
            <div class="col-md-5">
              <label for="">Unit</label>
              <select name="units" id="edit_unit">
                <option value="" type="text">select option</option>
              </select>
            </div><br><br>
            <div class="col-md-5">
              <label for="">Rate</label>
              <input type="text" id="edit_rate" class="form-control">
            </div><br>
            <div class="col-md-5">
              <label for="">stock</label>
              <input type="text" id="edit_stock" class="form-control">
            </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary " id="editsave">Update</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- filter modal -->
  <div class="modal fade" id="filtermodal" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-dialog">
        <form id="filter-form" class="filform">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="staticBackdropLabel">Filter Modal</h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="filter-row" style="display: flex;">
                <div class="col-md-2">
                  <select name="category" class="filter-category">
                    <option value="">Select a category</option>
                    <option value="productname">Product Name</option>
                    <option value="productcode">Product Code</option>
                    <option value="unit">Units</option>
                    <option value="stock">Stock</option>
                    <option value="rate">Rate</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <select name="criteria" class="filter-criteria">
                    <option value="">Select a criteria</option>
                    <option value="=">=</option>
                    <option value="!=">!=</option>
                    <option value="Starts with">Starts with</option>
                    <option value="Greater Than">Greater Than</option>
                    <option value="Less Than">Less Than</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <input type="text" class="filter-values" id="filter-values" placeholder="values">
                </div>
                <div class="col-md-2">
                  <select name="conjuction" class="filter-conjunction">
                    <option value="">select option</option>
                    <option value="AND">AND</option>
                    <option value="OR">OR</option>
                    <option value="ONLY">ONLY</option>
                  </select>
                </div>
                <div>
                  <button class="btn btn-danger delete-row">Delete</button>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary filterbtn" data-bs-dismiss="modal">Search</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>


  <script type="text/javascript">

    $(document).ready(function () {

      getdata();
      loadData();
      loadeditData();

      // clear pop up when written something
      $('#exampleModal').on('hidden.bs.modal', function () {
        $(this).find('form').trigger('reset');
        $("#pdcodecheck").hide();
        $("#pdnamecheck").hide();
        $("#unitcheck").hide();
        $("#ratecheck").hide();
        $("#stockcheck").hide();
      })

      $("#pdcodecheck").hide();
      $("#pdnamecheck").hide();
      $("#unitcheck").hide();
      $("#ratecheck").hide();
      $("#stockcheck").hide();


      //btnsave click function with validation
      $('#btnsave').click(function () {

        let id = $("#pdcode").val();

        if (id.length == "") {
          $("#pdcodecheck").show();

          return
        }
        let name = $("#pdname").val();

        if (name.length == "") {
          $("#pdnamecheck").show();

          return
        }
        let units = $("#units").val();

        if (units.length == "") {
          $("#unitcheck").show();

          return
        }
        let rate = $("#rate").val();

        if (rate.length == "") {
          $("#ratecheck").show();

          return
        }
        let stock = $("#stock").val();

        if (stock.length == "") {
          $("#stockcheck").show();

          return
        }

        let text = "you want to add this data into database";

        if (confirm(text) == true) {

          $.ajax({
            url: 'addproduct.php',
            type: 'POST',
            data: {
              'pdcode': $('#pdcode').val(),
              'pdname': $('#pdname').val(),
              'units': $('#units').val(),
              'rate': $('#rate').val(),
              'stock': $('#stock').val(),
            },

            success: function (data) {

              if (data == 1) {
                //confirm("are you sure to add these?");
                //alertify.success("data entered successfully");
                alert("data entered successfully");

              }
              else {
                alert("cancelled");
              }
            },
          });
        } else {
          alert('Oops!!! you cancelled');
        }
      });

      // fetch data from database to the table
      function getdata() {
        $.ajax({
          type: "POST",
          url: "getproduct.php",
          dataType: 'JSON',
          success: function (response) {

            $.each(response, function (key, value) {

              $('.productmaster').append('<tr>' +
                '<th scope="row" class="keycode" hidden="" >' + value['keycode'] + '</th>\
                  <td class="productcode" >'+ value['productcode'] + '</td>\
                  <td class="productname">'+ value['productname'] + '</td>\
                  <td class="units">'+ value['unit'] + '</td>\
                  <td class="rate">'+ value['rate'] + '</td>\
                  <td class="stock">'+ value['stock'] + '</td>\
                  <td><button type="button" class="btn btn-primary  edit_btn">\
                      Edit </button></td>\
                    <td><button type="button" class="btn btn-danger deletebtn">\
                      Delete </button></td>\
                    </tr>');
            });
          }
        });
      }

      // deleting data from the table
      $(document).on("click", ".deletebtn", function () {
        var keycode = $(this).closest('tr').find('.keycode').text();
        let text = "you want to delete this data from database";
        if (confirm(text) == true) {
          $.ajax({
            type: "POST",
            url: "deleteproduct.php",

            data: {
              'keycode': keycode,
            },
            success: function (response) {
              console.log(response);
              if (response == 1) {
                alertify.success('Data Deleted Successfully');
                $('.productmaster').html('');
                getdata();
              }
            }
          });
        } else {
          alertify.error('Oops!!! you cancelled');
        }
      });


      // fetch data for edit button
      $(document).on("click", ".edit_btn", function () {


        var pc = $(this).closest('tr').find('.productcode').text();
        var pn = $(this).closest('tr').find('.productname').text();
        var unit = $(this).closest('tr').find('.units').text();
        var rate = $(this).closest('tr').find('.rate').text();
        var stock = $(this).closest('tr').find('.stock').text();
        var keycode = $(this).closest('tr').find('.keycode').text();

        $('#edit_code').val(pc);
        $('#edit_name').val(pn);
        $('#edit_unit').val(unit);
        $('#edit_rate').val(rate);
        $('#edit_stock').val(stock);
        $('#keycode').val(keycode);
        $('#EditModal').modal('show');
      });

      //editing details in edit
      $('#editsave').click(function () {

        alertify.confirm("confirm update?.",
          function () {
            $.ajax({
              url: 'updateproduct.php',
              type: 'POST',

              data: {
                'productcode': $('#edit_code').val(),
                'productname': $('#edit_name').val(),
                'units': $('#edit_unit').val(),
                'rate': $('#edit_rate').val(),
                'stock': $('#edit_stock').val(),
                'keycode': $('#keycode').val(),
              },
              success: function (data) {
                //alert(data);
                if (data == 1) {
                  // alertalarm();
                  // alert('data has been updated');
                }
                if (data == 0) {
                  alert('something went wrong');
                }
              },
            });
            alertify.success('data updated.');
          },
          function () {
            alertify.error('Cancelled!!!');
          });
      });

      // search function
      $("#search").on("keyup", function () {
        var value = $(this).val().toLowerCase();
        $("#table tbody tr").filter(function () {
          $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
      });

      //loading data in units dropdown for addbtn 
      function loadData() {

        $.ajax({
          type: "post",
          url: "dropdown.php",
          dataType: 'JSON',

          // dataType: "html",                  
          success: function (data) {

            for (let i = 0; i < data.length; i++) {
              $('#units').append('<option class="units">' + data[i].unitname + '</option>');
              //$('#units').append('<select class="units">'+data[i].unit+'</select>');

            }
          }
        });
      }

      //loading data in units dropdown for editbtn 
      function loadeditData() {

        $.ajax({
          type: "post",
          url: "dropdown.php",
          dataType: 'JSON',

          // dataType: "html",                  
          success: function (data) {

            for (let i = 0; i < data.length; i++) {
              $('#edit_unit').append('<option class="units">' + data[i].unitname + '</option>');
              //$('#units').append('<select class="units">'+data[i].unit+'</select>');

            }
          }
        });
      }

      //loading navbar
      $(function () {
        $("#navbar").load("menu.html");
      });
      
      function initializeAutocomplete($row) {
        var $category = $row.find(".filter-category");
        var $valuesInput = $row.find(".filter-values");
        $valuesInput.val("");
        $category.on("change", function () {
          var selectedCategory = $(this).val();

          if (selectedCategory === "productname") {

            $.ajax({
              url: 'filterfetchdata.php',
              method: 'GET',
              dataType: 'json',
              success: function (data) {
                // Initialize Autocomplete
                $valuesInput.autocomplete({
                  source: data,
                  minLength: 0
                });
              },
              error: function (error) {
                console.error('Error fetching product names:', error);
              }
            });
          } else if (selectedCategory === "productcode") {

            $.ajax({
              url: 'fetchcodeforfilter.php',
              method: 'GET',
              dataType: 'json',
              success: function (data) {
                // Initialize Autocomplete
                $valuesInput.autocomplete({
                  source: data,
                  minLength: 0
                });
              },
              error: function (error) {
                console.error('Error fetching product codes:', error);
              }
            });
          } else if (selectedCategory === "unit") {

            $.ajax({
              url: 'fetchunitforfilter.php',
              method: 'GET',
              dataType: 'json',
              success: function (data) {
                // Initialize Autocomplete
                $valuesInput.autocomplete({
                  source: data,
                  minLength: 0
                });
              },
              error: function (error) {
                console.error('Error fetching units:', error);
              }
            });
          }
        });
      }

      //filter conjuction change event append clonedrow
      $(document).on("change", ".filter-conjunction", function () {
        var selectedConjunction = $(this).val();
        if (selectedConjunction === "AND" || selectedConjunction === "OR") {
          var clonedRow = $(this).closest(".filter-row").clone();
          clonedRow.find(".filter-conjunction").val("ONLY");
          clonedRow.find(".filter-values").val("");
          $(this).closest(".modal-body").append(clonedRow);
        }
      });


      // filterbtn validation
      $(".filterbtn").click(function () {
        var isValid = true;


        $(".filter-row").each(function () {
          var category = $(this).find(".filter-category").val();
          var criteria = $(this).find(".filter-criteria").val();
          var values = $(this).find(".filter-values").val();
          var conjunction = $(this).find(".filter-conjunction").val();

          if (category === "" || criteria === "" || values === "") {
            isValid = false;
            return false;
          }

          if (conjunction === "ONLY") {

          }
        });

        if (!isValid) {

          //alert("Please fill in all details in each row.");
          return false;
        }
      });

      // filter btn click function
      $(".filterbtn").click(function () {

        var filterCriteria = [];
        var isValid = true;

        $(".filter-row").each(function () {
          var category = $(this).find(".filter-category").val();
          var criteria = $(this).find(".filter-criteria").val();
          var values = $(this).find(".filter-values").val();
          var conjunction = $(this).find(".filter-conjunction").val();


          if (category === "" || criteria === "" || values === "") {
            isValid = false;
            return false;
          }

          filterCriteria.push({
            category: category,
            criteria: criteria,
            values: values,
            conjunction: conjunction,
          });
        });

        if (!isValid) {

          alert("Please fill in all details in each row.");
          return false;
        }

        //ajax to get filtered product
        $.ajax({
          url: 'filterproduct.php',
          type: 'POST',
          dataType: 'json',
          data: { filterCriteria: JSON.stringify(filterCriteria) },
          success: function (filteredData) {
            $('.productmaster').empty();
            $.each(filteredData, function (key, value) {

              $('.productmaster').append('<tr>' +
                '<th scope="row" class="keycode" hidden="" >' + value['keycode'] + '</th>\
                  <td class="productcode" >'+ value['productcode'] + '</td>\
                  <td class="productname">'+ value['productname'] + '</td>\
                  <td class="units">'+ value['unit'] + '</td>\
                  <td class="rate">'+ value['rate'] + '</td>\
                  <td class="stock">'+ value['stock'] + '</td>\
                  <td><button type="button" class="btn btn-primary  edit_btn">\
                  Edit </button></td>\
                  <td><button type="button" class="btn btn-danger deletebtn">\
                  Delete </button></td>\
                  </tr>');
            });
          },
          error: function () {
            alert('An error occurred while fetching filtered data.');
          },
        });
      });


      // delete row of filter table 
      $(document).on('click', '.delete-row', function () {

        var $firstRow = $(this).closest('.filter-row');
        if ($firstRow.is(':first-child')) {
          $firstRow.find('select').val('');
          $firstRow.find('input').val('');
        } else {
          $firstRow.remove();
        }
      });

      //fetching data from backend
      function fetchProductNames() {
        $.ajax({
          url: 'filterfetchdata.php',
          method: 'GET',
          dataType: 'json',
          success: function (data) {
            if (Array.isArray(data)) {
              productNames = data;
              console.log('Product names fetched:', productNames);
            }
          },
          error: function (error) {
            console.error('Error fetching product names:', error);
          }
        });
      }

      // Initialize Autocomplete and fetch product names when the modal is shown
      $(document).on('shown.bs.modal', '#filtermodal', function () {
        // Fetch product names from the backend
        fetchProductNames();

        // Initialize Autocomplete inside the modal
        $(".filter-category").on("change", function () {
          var selectedCategory = $(this).val();
          var $valuesInput = $(this).closest(".filter-row").find(".filter-values");

          if (selectedCategory === "productname") {
            $valuesInput.autocomplete({
              source: productNames,
              select: function (event, ui) {
                $valuesInput.val(ui.item.value);
              },
            });
          } else {
            $valuesInput.autocomplete("destroy");
          }
        });

        // Clear input fields when the modal is shown
        $(".filter-values").val("");
        $(".filter-category").val("");
        $(".filter-criteria").val("");
        $(".filter-conjunction").val("");

      });


    });
  </script>
</body>

</html>